<#
.SYNOPSIS
    STIG Check: V-220714
    Severity: medium

.DESCRIPTION
    Rule Title: Only authorized user accounts must be allowed to create or run virtual machines on Windows 10 systems.
    STIG ID: WN10-00-000080
    Rule ID: SV-220714r958478

    Allowing other operating systems to run on a secure system may allow users to circumvent security. For Hyper-V, preventing unauthorized users from being assigned to the Hyper-V Administrators group will prevent them from accessing or creating virtual machines on the system. The Hyper-V Hypervisor is used by Virtualization Based Security features such as Credential Guard on Windows 10; however, it is not the full Hyper-V installation.

.PARAMETER Config
    Configuration file path (JSON)

.PARAMETER OutputJson
    Output results in JSON format to specified file

.OUTPUTS
    Exit Codes:
        0 = Check Passed (Compliant)
        1 = Check Failed (Finding)
        2 = Check Not Applicable
        3 = Check Error
#>

[CmdletBinding()]
param(
    [Parameter(Mandatory=$false)]
    [string]$Config,

    [Parameter(Mandatory=$false)]
    [string]$OutputJson
)

# Configuration
$VULN_ID = "V-220714"
$STIG_ID = "WN10-00-000080"
$SEVERITY = "medium"
$TIMESTAMP = (Get-Date).ToUniversalTime().ToString("yyyy-MM-ddTHH:mm:ssZ")

# Load configuration if provided
if ($Config -and (Test-Path $Config)) {
    $ConfigData = Get-Content $Config | ConvertFrom-Json
}

################################################################################
# MAIN CHECK LOGIC
################################################################################

try {
    # STIG Check Implementation - Manual Review Required
    Write-Output "================================================================================"
    Write-Output "STIG Check: $VULN_ID"
    Write-Output "STIG ID: $STIG_ID"
    Write-Output "Severity: $SEVERITY"
    Write-Output "Timestamp: $TIMESTAMP"
    Write-Output "================================================================================"
    Write-Output ""
    Write-Output "MANUAL REVIEW REQUIRED"
    Write-Output "This STIG check requires manual verification of Windows configuration."
    Write-Output "Please consult the STIG documentation for specific compliance requirements."
    Write-Output ""
    Write-Output "Status: Not_Reviewed"
    Write-Output "================================================================================"

    if ($OutputJson) {
        @{
            vuln_id = $VULN_ID
            stig_id = $STIG_ID
            severity = $SEVERITY
            status = "Not_Reviewed"
            finding_details = "Manual review required"
            comments = "Consult STIG documentation for Windows compliance verification"
            timestamp = $TIMESTAMP
            requires_manual_review = $true
        } | ConvertTo-Json | Out-File $OutputJson
    }

    exit 2  # Manual review required


} catch {
    Write-Error $_.Exception.Message

    if ($OutputJson) {
        @{
            vuln_id = $VULN_ID
            stig_id = $STIG_ID
            severity = $SEVERITY
            status = "ERROR"
            message = $_.Exception.Message
            timestamp = $TIMESTAMP
        } | ConvertTo-Json | Out-File $OutputJson
    }

    exit 3
}
